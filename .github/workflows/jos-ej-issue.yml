name: junie

on:
  workflow_call:
    inputs:
      workflow_params:
        description: "JSON string containing all workflow parameters"
        type: string
        required: true
      runs-on:
        description: "Which runner use to run junie"
        type: string
        default: "ubuntu-latest"
        required: false
      junie_ide:
        description: "IDE which will be used to handle tasks. Current available options are IdeaUltimate or PhpStorm, defaults to standalone mode (None)"
        type: string
        default: "None"
        required: false
      fix_conflicts:
        description: "allow Junie to auto resolve PR conflicts"
        default: false
        type: boolean
        required: false
    secrets:
      JUNIE_SECRETS_JSON:
        description: "JSON string containing secrets for the Junie agent"
        required: false

jobs:
  run-junie:
    runs-on: ${{ inputs.runs-on }}
    permissions:
      contents: write
    steps:
      - name: Extract workflow params
        id: workflow-params
        uses: actions/github-script@v7
        env:
          INPUT_PARAMS: ${{ inputs.workflow_params }}
          JUNIE_SECRETS_JSON: ${{ secrets.JUNIE_SECRETS_JSON }}
          INPUT_JUNIE_IDE: ${{ inputs.junie_ide }}
        with:
          script: |
            const params = JSON.parse(core.getInput('params'));
            
            if (process.env.JUNIE_SECRETS_JSON) {
              const secrets = JSON.parse(process.env.JUNIE_SECRETS_JSON);
              Object.values(secrets).forEach(value => {
                console.log(`::add-mask::${value}`);
              });
            }

            // Add workflow start time in milliseconds
            const workflowStartTime = Date.now();
            console.log('Workflow start time (ms):', workflowStartTime);

            const finalParams = { 
              junie_ide_version: '251',
              junie_version: '443.1',
              workflow_start_time: workflowStartTime,  
              ...params,                           
            };

            if (finalParams.issue_body) {
              finalParams.ej_task_text =  `### ${finalParams.issue_title}` + '\n' + `${finalParams.issue_body}`;
            }

            if (finalParams.merge_base_commit_sha) {
              finalParams.junie_ide = "None"              
            } else {
              finalParams.junie_ide = core.getInput('junie_ide')
            }      
            
            Object.keys(finalParams).forEach((key) => {
                core.setOutput(key, finalParams[key]);
            });

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.workflow-params.outputs.checkout_ref }}

      - name: Fetch refs for resolve conflicts
        id: merge
        if: steps.workflow-params.outputs.merge_base_commit_sha != ''
        env:
          TASK_JSON: ${{ steps.workflow-params.outputs.task }}
        run: |
          BASE="$(jq -r 'try .merge.branch // empty' <<<"${TASK_JSON:-}" 2>/dev/null || true)"          
          if [[ -n "$BASE" ]]; then
            HEAD=${{ steps.workflow-params.outputs.checkout_ref }}
            MB="${{ steps.workflow-params.outputs.merge_base_commit_sha }}"
            git fetch --no-tags --depth=1 origin "$BASE" "$HEAD"
            git fetch --no-tags --depth=1 origin "$MB"
            CUTOFF=$(git show -s --format=%cI $MB | xargs -I{} date -u -d "{} - 10 seconds" +"%Y-%m-%dT%H:%M:%SZ")
            PARENTS=$(git cat-file -p $MB | awk '/^parent / {print $2}')
            for p in $PARENTS; do
              git fetch --shallow-since="$CUTOFF" origin "$BASE" "$HEAD"
            done     
            git branch $BASE origin/$BASE
          else
            echo "No target PR branch; skipping fetch/checkout."
          fi

      # need to sync with step run_junie_in_container
      # ~/.gitconfig in container will be isolated from agent environment
      - name: Init git configuration
        run: |
          git config --global user.name 'junie-eap[bot]'
          git config --global user.email 'junie-eap[bot]@users.noreply.github.com'
          git config --global http.postBuffer 157286400

      - name: Make all scripts in .devcontainer executable
        if: always() && (hashFiles('.devcontainer/devcontainer.json') != '')
        run: find .devcontainer -type f -name "*.sh" -exec chmod +x {} \;

      - name: Prepare container and run Junie
        id: run_junie_in_container
        if: always() && (hashFiles('.devcontainer/devcontainer.json') != '')
        uses: devcontainers/ci@v0.3
        timeout-minutes: 120
        env:
          EJ_TASK: ${{ steps.workflow-params.outputs.task }}
          EJ_AUTH_GITHUB_TOKEN: ${{ steps.workflow-params.outputs.junie_runner_token  }}
          EJ_TASK_TEXT: ${{ steps.workflow-params.outputs.ej_task_text }}
          MULTI_RUNS: true
          MATTERHORN_DEBUG_LOG: false
          JUNIE_SECRETS_JSON: ${{ secrets.JUNIE_SECRETS_JSON }}
        with:
          push: never
          env: |
            EJ_TASK
            EJ_AUTH_GITHUB_TOKEN  
            EJ_AUTH_INGRAZZIO_GITHUB_TOKEN
            EJ_TASK_TEXT
            MULTI_RUNS
            MATTERHORN_DEBUG_LOG
            JUNIE_SECRETS_JSON
          runCmd: |
            set -e
            mkdir /tmp/junie-work
            JUNIE_WORK_TEMP="/tmp/junie-work"
            echo "Junie working directory: $JUNIE_WORK_TEMP"
            
            command_exists() {
              command -v "$1" >/dev/null 2>&1
            }
            
            echo "Installing IDEA dependencies"
            
            if [[ "$OSTYPE" == linux* ]]; then
              if command_exists "apt-get"; then
                sudo apt-get -qq update
                sudo apt-get -qq install -y libfreetype6 fonts-liberation fontconfig
              elif command_exists "pacman"; then
                sudo pacman -Sy --noconfirm freetype2 ttf-liberation fontconfig
              else
                echo "Error: No supported package manager found (apt-get or pacman)"
              fi
            fi

            if [ -n "$JUNIE_SECRETS_JSON" ]; then
              declare -a env_kvs=()
            
              while IFS= read -r -d '' key && IFS= read -r -d '' value; do
                [[ $key =~ ^[A-Za-z_][A-Za-z0-9_]*$ ]] || { echo "Skipping invalid key: $key" >&2; continue; }
                env_kvs+=("$key=$value")
              done < <(
                jq -j '
                  to_entries[]
                  | select(.value != null)
                  | .key, "\u0000", (.value | tostring), "\u0000"
                ' <<< "$JUNIE_SECRETS_JSON"
              )
            
              for kv in "${env_kvs[@]}"; do
                export "$kv"
              done

              echo "Loaded environment variables from JUNIE_SECRETS_JSON"
            fi
            
            export EJ_FOLDER_WORK=$JUNIE_WORK_TEMP
            export EJ_FOLDER_IDE_CACHES=$JUNIE_WORK_TEMP
            export EJ_FOLDER_IDE_CONFIG=$JUNIE_WORK_TEMP
            export EJ_FOLDER_AGENT_CACHES=$JUNIE_WORK_TEMP
            export EJ_PROJECT=$(realpath ".")

            decoded_payload=$(echo "${{ steps.workflow-params.outputs.ingrazzio_token_jwt }}" | cut -d'.' -f2 | base64 -d)
            export EJ_AUTH_INGRAZZIO_GITHUB_TOKEN=$(echo "$decoded_payload" | sed -n 's/.*"sub"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p')

            cd $JUNIE_WORK_TEMP
            echo "Downloading ej-runner"
            wget -nv "https://github.com/jetbrains-junie/artifacts/releases/download/${{ steps.workflow-params.outputs.junie_version }}/junie.sh" -O junie.sh

            echo "Running ej-runner"
            
            # Calculate time limit: 120 minutes minus time passed since workflow start
            current_time=$(date +%s%N | cut -b1-13)  # Get current time in milliseconds
            time_passed=$((current_time - ${{ steps.workflow-params.outputs.workflow_start_time }}))
            export JUNIE_TIME_LIMIT=$((6600000 - time_passed))  # 6600000 = 110 minutes in milliseconds
            echo "Current time (ms): $current_time"
            echo "Time passed since workflow start (ms): $time_passed"
            echo "Time limit set to (ms): $JUNIE_TIME_LIMIT"
            
            export EJ_IDE_NAME="${{ steps.workflow-params.outputs.junie_ide }}"
            export JUNIE_VERSION="${{ steps.workflow-params.outputs.junie_version }}"
            export JUNIE_IDE_VERSION="${{ steps.workflow-params.outputs.junie_ide_version }}"
            # GH agent git settings with devcontainer environment for resolve conflicts tasks
            git config --global user.name 'junie-eap[bot]'
            git config --global user.email 'junie-eap[bot]@users.noreply.github.com'

            chmod +x ./junie.sh 
            /bin/sh ./junie.sh


      - name: Check if junie run failed
        if: failure() && (hashFiles('.devcontainer/devcontainer.json') != '')
        run: |
          mkdir -p .junie-upload/.matterhorn/out/
          echo "${{ steps.run_junie_in_container.outputs.runCmdOutput }}" >> .junie-upload/.matterhorn/out/containerError.md

      - name: Extracting .idea and ej-logs from container
        if: always() && (hashFiles('.devcontainer/devcontainer.json') != '')
        run: |
          CONTAINER_ID=$(docker container ls --filter "label=devcontainer.config_file" --quiet | head -n 1)
          echo "CONTAINER=$CONTAINER_ID"

          mkdir -p .junie-upload

          docker cp "$CONTAINER_ID":"/tmp/junie-work/.matterhorn" .junie-upload/.matterhorn || echo "No .matterhorn"
          docker cp "$CONTAINER_ID":"/tmp/junie-work/idea-logs/log/idea.log" .junie-upload/.matterhorn/idea.log || echo "No idea-logs"          
          sudo chown -R runner:runner ${{ github.workspace }} || true

          # rename containerError.md to executionError.md if main.log exists (aka execution took place)
          LOG_FILE=".junie-upload/.matterhorn/.matterhorn/out/main.log"
          CONTAINER_ERROR_FILE=".junie-upload/.matterhorn/out/containerError.md"
          EXECUTION_ERROR_FILE=".junie-upload/.matterhorn/out/executionError.md"
          
          # Check if the log file exists
          if [ -f "$LOG_FILE" ]; then
            # Check if the error file exists before attempting to rename
            if [ -f "$CONTAINER_ERROR_FILE" ]; then
              # Rename the error file
              mv "$CONTAINER_ERROR_FILE" "$EXECUTION_ERROR_FILE"
              echo "Renamed $CONTAINER_ERROR_FILE to $EXECUTION_ERROR_FILE"
            fi
          else
            echo "$LOG_FILE doesn't exist, assuming container error"
          fi

      - name: Run Junie without container
        if: always() && (hashFiles('.devcontainer/devcontainer.json') == '')
        timeout-minutes: 120
        env:
          EJ_TASK: ${{ steps.workflow-params.outputs.task }}
          EJ_AUTH_GITHUB_TOKEN: ${{ steps.workflow-params.outputs.junie_runner_token  }}
          EJ_TASK_TEXT: ${{ steps.workflow-params.outputs.ej_task_text }}
          MULTI_RUNS: true
          MATTERHORN_DEBUG_LOG: false
          JUNIE_SECRETS_JSON: ${{ secrets.JUNIE_SECRETS_JSON }}
        run: |
          mkdir /tmp/junie-work
          JUNIE_WORK_TEMP="/tmp/junie-work"
          echo "Junie working directory: $JUNIE_WORK_TEMP"
          
          export EJ_FOLDER_WORK=$JUNIE_WORK_TEMP
          export EJ_FOLDER_IDE_CACHES=$JUNIE_WORK_TEMP
          export EJ_FOLDER_IDE_CONFIG=$JUNIE_WORK_TEMP
          export EJ_FOLDER_AGENT_CACHES=$JUNIE_WORK_TEMP
          export EJ_PROJECT=$(realpath ".")

          if [ -n "$JUNIE_SECRETS_JSON" ]; then
            declare -a env_kvs=()
          
            while IFS= read -r -d '' key && IFS= read -r -d '' value; do
              [[ $key =~ ^[A-Za-z_][A-Za-z0-9_]*$ ]] || { echo "Skipping invalid key: $key" >&2; continue; }
              env_kvs+=("$key=$value")
            done < <(
              jq -j '
                to_entries[]
                | select(.value != null)
                | .key, "\u0000", (.value | tostring), "\u0000"
              ' <<< "$JUNIE_SECRETS_JSON"
            )
          
            for kv in "${env_kvs[@]}"; do
              export "$kv"
            done

            echo "Loaded environment variables from JUNIE_SECRETS_JSON"
          fi

          decoded_payload=$(echo "${{ steps.workflow-params.outputs.ingrazzio_token_jwt }}" | cut -d'.' -f2 | base64 -d)
          export EJ_AUTH_INGRAZZIO_GITHUB_TOKEN=$(echo "$decoded_payload" | sed -n 's/.*"sub"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p')

          cd $JUNIE_WORK_TEMP
          
          echo "Downloading ej-runner"
          sudo wget -nv "https://github.com/jetbrains-junie/artifacts/releases/download/${{  steps.workflow-params.outputs.junie_version }}/junie.sh" -O junie.sh

          echo "----- junie.sh (begin) -----"
          cat junie.sh
          echo "----- junie.sh (end) -----"

          echo "Running ej-runner"
          # Calculate time limit: 120 minutes minus time passed since workflow start
          current_time=$(date +%s%N | cut -b1-13)  # Get current time in milliseconds
          time_passed=$((current_time - ${{ steps.workflow-params.outputs.workflow_start_time }}))
          export JUNIE_TIME_LIMIT=$((6600000 - time_passed))  # 6600000 = 110 minutes in milliseconds
          echo "Current time (ms): $current_time"
          echo "Time passed since workflow start (ms): $time_passed"
          echo "Time limit set to (ms): $JUNIE_TIME_LIMIT"

          export EJ_IDE_NAME="${{ steps.workflow-params.outputs.junie_ide }}"
          export JUNIE_VERSION="${{  steps.workflow-params.outputs.junie_version }}"
          export JUNIE_IDE_VERSION="${{ steps.workflow-params.outputs.junie_ide_version }}"

          sudo chmod +x ./junie.sh
          /bin/sh ./junie.sh

      - name: Extracting .idea and ej-logs for non-container run
        if: always() && (hashFiles('.devcontainer/devcontainer.json') == '')
        run: |
          echo "Copying logs to target dir..."
          sudo chown -R runner:runner /tmp/junie-work
          sudo chown -R runner:runner ${{ github.workspace }} || true
          mkdir .junie-upload
          cp -r /tmp/junie-work/.matterhorn .junie-upload/.matterhorn
          cp -r /tmp/junie-work/idea-logs/log/idea.log .junie-upload/.matterhorn/idea.log || true

      - name: Save junie result summary
        id: junie_summary
        continue-on-error: true
        run: |
          summary=$(jq -r '.content.output | select(. != null)' .junie-upload/.matterhorn/issue_md.*)
          echo "summary is $summary"
          {
            echo "summary<<EOF"
            echo "$summary"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          name=$(jq -r '.content.title | select(. != null)' .junie-upload/.matterhorn/issue_md.*)
          echo "name is $name, fallback is ${{ steps.workflow-params.outputs.fallback_result_title }}"
          name=${name:-"${{ steps.workflow-params.outputs.fallback_result_title }}"}
          echo "name=$name" >> "$GITHUB_OUTPUT" 

      - name: Archive output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: output
          path: |
            .junie-upload/.matterhorn/out/
            !.junie-upload/.matterhorn/out/attachments/**/*
          retention-days: 7

      - name: Archive attachments
        if: always()
        uses: actions/upload-artifact@v4
        with:
          if-no-files-found: ignore
          name: attachments
          path: .junie-upload/.matterhorn/out/attachments
          retention-days: 7

      - name: Upload junie logs
        if: always() && steps.workflow-params.outputs.logs_storage == 'cloud'
        continue-on-error: true
        run: |
          set -e
          cd .junie-upload/
          tar -cJf matterhorn-logs.tar.xz -C .matterhorn .

          # Check file size
          file_size=$(wc -c < matterhorn-logs.tar.xz)
          if [ "$file_size" -gt 10485760 ]; then
            echo "Archive too large, skipping upload"
            exit 1
          fi

          echo "Uploading logs to API endpoint..."
          curl -X POST "${{ steps.workflow-params.outputs.api_base_url }}/run/upload-logs" \
            -H "Accept: application/json" \
            -F "file=@matterhorn-logs.tar.xz" \
            -F "token=${{ steps.workflow-params.outputs.run_id_token }}" \
            --fail-with-body  --show-error

      - name: Upload junie logs to GitHub
        if: always() && steps.workflow-params.outputs.logs_storage != 'cloud'
        uses: actions/upload-artifact@v4
        with:
          name: matterhorn-logs
          path: .junie-upload/.matterhorn
          include-hidden-files: 'true'
          retention-days: 3

      - name: Restore or remove .idea directory
        run: |
          sudo rm -rf .junie-upload
          sudo rm -rf .output.txt
          sudo rm -rf solution.patch

          if git ls-tree -d HEAD .idea | grep "\.idea" >/dev/null 2>&1; then
            echo "Restoring tracked '.idea' directory"
            git checkout -- .idea
            git clean -f -d .idea            
          else
            echo "Removing untracked '.idea' directory"
            sudo rm -rf .idea
          fi

      - name: Fetch PR creation token
        id: pull-request-token
        run: |
          response_and_status="$(
            curl -s -w "\n%{http_code}" -X POST "${{ steps.workflow-params.outputs.api_base_url }}/token/exchange" \
              -H "Content-Type: application/json" \
              -H "Accept: application/json" \
              -d "{\"runIdToken\":\"${{ steps.workflow-params.outputs.run_id_token }}\",\"tokens\":[\"PULL_REQUEST_CREATION\"]}"
          )"

          status=$(echo "$response_and_status" | tail -n1)
          body=$(echo "$response_and_status" | head -n -1)

          echo "HTTP status: $status"

          if echo "$body" | jq -e . >/dev/null 2>&1; then
            value=$(echo "$body" | jq -r '.PULL_REQUEST_CREATION')
            echo "pull_requests_creation_token=$value" >> "$GITHUB_OUTPUT"
          else
            echo "Non-JSON response body: $body"
          fi


      - name: Make Pull Request for the changes
        if: steps.workflow-params.outputs.trigger != 'Junie Portal' && steps.workflow-params.outputs.target_ref != steps.workflow-params.outputs.checkout_ref
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ steps.pull-request-token.outputs.pull_requests_creation_token }}
          commit-message: "${{ steps.junie_summary.outputs.name }} \n ${{ steps.junie_summary.outputs.summary }}"
          title: "[Junie]: ${{ steps.junie_summary.outputs.name }}"
          body: |
            ## üìå Hey! This PR was made for you with Junie, the coding agent by JetBrains **Early Access Preview**

            It's still learning, developing, and might make mistakes. Please make sure you review the changes before you accept them.
            We'd love your feedback ‚Äî join our Discord to share bugs, ideas: [here](https://jb.gg/junie/github).

            - üîó **Issue:** Fixes: #${{ steps.workflow-params.outputs.issue_id }}
            - ‚öôÔ∏è **Trigger:** ${{ steps.workflow-params.outputs.trigger }}           

            ${{ steps.junie_summary.outputs.summary != '' && '### üìä Junie Summary' }}
            ${{ steps.junie_summary.outputs.summary != '' && steps.junie_summary.outputs.summary }}
          branch: ${{ steps.workflow-params.outputs.target_ref }}
          base: ${{ steps.workflow-params.outputs.checkout_ref }}

      - uses: EndBug/add-and-commit@v9
        name: Commit changes
        if: steps.workflow-params.outputs.trigger == 'Junie Portal' || steps.workflow-params.outputs.target_ref == steps.workflow-params.outputs.checkout_ref
        with:
          new_branch: ${{ steps.workflow-params.outputs.target_ref }}
          author_name: junie-eap[bot]
          author_email: junie-eap[bot]@users.noreply.github.com
          message: |
            [issue-${{ steps.workflow-params.outputs.issue_id }}] ${{ steps.junie_summary.outputs.name }}

            ${{ steps.junie_summary.outputs.summary }}